# Basketball 目标检测与进球检测系统

## 项目概述

本项目是一个完整的篮球目标检测和进球检测系统，基于深度学习技术实现实时篮球比赛分析。系统采用单YOLO模型架构，能够同时检测篮球和篮筐，并通过多维度分析判断进球事件。

### 主要功能

- **实时篮球检测**：使用YOLO模型实时检测篮球位置
- **篮筐检测**：自动检测篮筐位置并进行位置平滑
- **进球检测**：基于位置变化、水平碰撞和速度变化的综合分析
- **目标跟踪**：跟踪篮球运动轨迹和速度
- **可视化输出**：标注视频并保存详细的进球事件记录

## 系统架构

### 单模型检测架构

系统采用**单YOLO模型**架构，使用单个模型同时检测篮球和篮筐：

```
输入视频
    │
    ▼
┌─────────────────────────────────┐
│  视频预处理 (VideoPreprocessor)  │
├─────────────────────────────────┤
│  • 亮度归一化 (LAB色彩空间)      │
│    - 目标亮度: 128              │
│    - 调整强度: 0.3              │
│  • Letterbox缩放 (保持宽高比)    │
│    - 目标尺寸: 640x640          │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│  单YOLO模型检测                 │
├─────────────────────────────────┤
│  • 模型: YOLO (BR2)            │
│  • 输入分辨率: 640              │
│  • 置信度阈值: 0.5              │
│  • 检测类别: ball, rim, people  │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│  目标跟踪与过滤                 │
├─────────────────────────────────┤
│  • 篮球跟踪器 (BallTracker)     │
│    - 轨迹记录: 30帧             │
│    - 速度计算                   │
│  • 静止球过滤                   │
│    - 静止阈值: 60帧             │
│  • 跳跃检测过滤                 │
│    - 跳跃阈值: 200像素          │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│  进球检测 (GoalDetector)        │
├─────────────────────────────────┤
│  • 位置变化检测                 │
│  • 水平碰撞检测                 │
│  • 速度变化检测                 │
│  • 综合验证                     │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│  可视化输出 (VideoAnnotator)    │
├─────────────────────────────────┤
│  • 篮球边界框 (绿色)            │
│  • 篮筐边界框 (蓝色)            │
│  • 运动轨迹 (黄色, 30帧)        │
│  • 进球计数器 (右上角)          │
│  • 进球高亮 "GOAL!" (红色)      │
└─────────────────────────────────┘
    │
    ▼
输出: 标注视频 + JSON事件记录 + CSV统计
```

## 完整处理流程

### 1. 视频输入与预处理

- 读取视频帧
- 亮度归一化（LAB色彩空间）
- Letterbox缩放（保持宽高比）

### 2. 目标检测

- 使用单YOLO模型同时检测篮球和篮筐
- 篮筐检测缓存（每5帧更新一次）
- 篮筐位置平滑（3帧滑动平均）

### 3. 检测结果过滤

- 静止球过滤：静止超过60帧的球被认为是误检
- 跳跃检测过滤：突然跳跃的检测结果被过滤

### 4. 目标跟踪

- 跟踪篮球运动轨迹
- 计算运动速度和方向
- 记录位置历史

### 5. 进球检测

#### 5.1 核心检测算法

```
输入: 篮球跟踪器, 篮筐边界框, 帧ID
输出: 是否检测到进球

处理流程:
1. 冷却期检查（进球后60帧内不重复检测）
2. 篮筐位置和半径计算
3. 球位置记录（上方）
4. 位置变化检测（从上方到下方）
5. 水平碰撞检测（球与篮筐边界）
6. 速度变化检测（球穿过篮筐时）
7. 综合验证（位置 + 碰撞 + 速度）
8. 记录进球事件
```

#### 5.2 进球判断条件

- **位置变化**：球从篮筐上方移动到下方
- **水平接近**：球在篮筐水平范围内
- **时间间隔**：3-35帧内完成穿越
- **水平碰撞**：球与篮筐边界发生碰撞
- **速度变化**：球穿过篮筐时速度发生变化
- **垂直速度**：球有明显的向下速度

### 6. 可视化输出

- 绘制篮球和篮筐边界框
- 绘制篮球运动轨迹
- 显示进球计数
- 高亮显示进球事件
- 保存标注后的视频
- 保存进球事件JSON记录
- 保存统计信息CSV文件

## 目录结构

```
basketball/
├── goal_detection/              # 进球检测系统核心
│   ├── config/                 # 配置文件
│   │   └── goal_detection_config.yaml
│   ├── detector/               # 检测器模块
│   │   └── goal_detector.py    # 进球检测器（v1.1优化版）
│   ├── tracker/                # 跟踪器模块
│   │   └── ball_tracker.py     # 篮球跟踪器
│   ├── utils/                  # 工具函数
│   │   ├── geometry.py         # 几何计算工具
│   │   └── video_preprocessor.py  # 视频预处理器
│   ├── visualizer/             # 可视化模块
│   │   └── video_annotator.py  # 视频标注器
│   ├── goal_detection.py       # 主程序（单YOLO模型）
│   └── goal_detection_rtdetr.py  # RT-DETR版本主程序
│
├── models/                     # 模型相关
│   ├── BR2/                    # 训练好的BR2模型（v1.1默认模型）
│   │   └── weights/
│   │       └── best.pt
│   ├── BR3/                    # 训练好的BR3模型
│   ├── attention/              # 注意力机制模块
│   ├── blocks/                 # 网络块模块
│   └── losses/                 # 损失函数模块
│
├── scripts/                    # 训练和推理脚本
│   ├── train_ball_model.py     # 篮球模型训练
│   ├── train_rim_model.py      # 篮筐模型训练
│   ├── predict_video_mp4.py    # 视频预测脚本
│   └── convert_*.py            # 数据集格式转换脚本
│
├── test/                       # 测试视频
│   ├── basketball2.mp4
│   ├── basketball3.mp4
│   └── basketball6.mp4
│
├── check_*.py                  # 数据集检查工具
├── clean_*.py                  # 数据集清理工具
├── merge_*.py                  # 数据集合并工具
├── move_*.py                   # 数据集文件移动工具
├── remove_*.py                 # 数据集清理工具
├── test_*.py                   # 测试脚本
└── README.md                   # 项目说明文件
```

## 技术参数汇总

| 模块 | 参数 | 值 | 说明 |
|------|------|-----|------|
| 模型检测 | 置信度阈值 | 0.5 | 检测置信度阈值 |
| 模型检测 | 输入分辨率 | 640 | 模型输入分辨率 |
| 篮筐检测 | 更新间隔 | 5帧 | 每5帧更新一次篮筐位置 |
| 篮筐检测 | 平滑窗口 | 3帧 | 篮筐位置平滑窗口 |
| 静止过滤 | 静止阈值 | 60帧 | 约2秒@30fps |
| 静止过滤 | 位置容差 | 30像素 | 位置网格化精度 |
| 跳跃过滤 | 跳跃阈值 | 200像素 | 单帧最大移动距离 |
| 进球检测 | 篮筐扩展 | 1.2x | 篮筐区域扩展比例 |
| 进球检测 | 连续帧数 | 3帧 | 最小连续帧数要求 |
| 进球检测 | 冷却期 | 60帧 | 约2秒@30fps |
| 进球检测 | 速度变化阈值 | 0.3 | 水平速度变化阈值 |
| 可视化 | 轨迹长度 | 30帧 | 显示最近30帧轨迹 |
| 可视化 | 进球高亮 | 90帧 | 约3秒@30fps |

## 快速开始

### 环境要求

- Python 3.8+
- Ultralytics (YOLO)
- OpenCV
- PyTorch
- NumPy, Pandas, PyYAML

### 安装依赖

```bash
pip install -r requirements.txt
```

### 运行进球检测

```bash
python goal_detection/goal_detection.py \
    --model models/BR2/weights/best.pt \
    --video test/basketball2.mp4 \
    --config goal_detection/config/goal_detection_config.yaml \
    --output runs/goal_detection/output.mp4 \
    --debug
```

### 命令行参数说明

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| --model | str | 是 | 检测模型路径（同时检测篮球和篮筐） |
| --video | str | 是 | 输入视频路径 |
| --config | str | 否 | 配置文件路径，默认：goal_detection/config/goal_detection_config.yaml |
| --output | str | 否 | 输出视频路径 |
| --debug | bool | 否 | 开启调试模式，输出详细检测统计 |

## 输出文件

运行后会生成以下输出文件：

- `output.mp4` - 标注后的视频（包含边界框、轨迹、进球高亮）
- `goal_events.json` - 进球事件详细记录（包含位置、速度、轨迹等）
- `goal_statistics.csv` - 进球统计信息（包含进球时间、位置等）

### JSON事件记录示例

```json
[
  {
    "frame_id": 1250,
    "timestamp": 41.67,
    "ball_position": [640, 480],
    "rim_position": [640, 320],
    "ball_velocity": [2.5, 5.8, 6.3],
    "ball_radius": 15.5,
    "rim_radius": 45.2,
    "trajectory": [[630, 450], [635, 465], [640, 480]]
  }
]
```

## 模型训练

### 训练单模型（同时检测篮球和篮筐）

```bash
python scripts/train_ball_model.py \
    --data data.yaml \
    --model yolov8n.yaml \
    --epochs 100 \
    --batch 16 \
    --name BR2
```

### 数据集准备

系统提供了多种数据集处理工具：

- `merge_datasets.py` - 合并多个数据集
- `convert_voc_to_yolo.py` - VOC格式转YOLO格式
- `convert_yolo_to_coco.py` - YOLO格式转COCO格式
- `remove_duplicates.py` - 移除重复图像
- `check_file_consistency.py` - 检查文件一致性

## 技术特点

1. **单模型设计**：使用单个YOLO模型同时检测篮球和篮筐，简化系统架构
2. **多维度进球检测**：结合位置变化、水平碰撞和速度变化进行综合判断
3. **实时处理**：优化的算法设计，支持实时视频处理
4. **鲁棒性强**：考虑了球和篮筐的大小变化，适应不同场景
5. **详细的事件记录**：记录球的位置、速度、轨迹等详细信息
6. **可配置性高**：提供了详细的配置参数，可根据不同场景进行调整
7. **模块化结构**：清晰的模块划分，便于维护和扩展

## 应用场景

1. **篮球比赛分析**：自动统计进球数，分析球员表现
2. **训练辅助**：帮助教练分析球员投篮效果
3. **直播增强**：为篮球比赛直播添加实时进球检测和统计
4. **视频内容分析**：自动标记篮球视频中的关键事件
5. **体育科学研究**：分析篮球运动轨迹和投篮技术

## 测试结果

| 视频 | 进球数 | 篮球检测率 | 篮筐检测率 | 进球检测准确率 |
|------|--------|-----------|-----------|----------------|
| basketball2.mp4 | 2 | 95.2% | 99.0% | 100% |
| basketball6.mp4 | 17 | 92.8% | 99.5% | 94.1% |

## 版本历史

### v1.1（最新）
- **优化进球检测逻辑**：添加水平碰撞检测和速度变化检测
- **增强事件记录**：记录球和篮筐半径信息
- **改进配置系统**：添加速度变化检测相关参数
- **优化代码结构**：提高代码可读性和可维护性

### v1.0
- **初始版本**：实现基本的篮球检测、篮筐检测和进球检测
- **单模型架构**：使用单个YOLO模型同时检测篮球和篮筐
- **实时处理**：支持实时视频处理
- **可视化输出**：标注视频并保存事件记录

## 注意事项

1. **模型选择**：推荐使用 `models/BR2/weights/best.pt` 模型
2. **配置文件**：使用 `goal_detection/config/goal_detection_config.yaml`
3. **GPU要求**：建议使用GPU加速推理
4. **视频格式**：支持常见视频格式（mp4, avi等）
5. **光线条件**：在良好的光线条件下检测效果最佳
6. **相机角度**：建议使用侧面或正面视角，避免极端俯角

## 故障排除

### 常见问题

1. **检测不到篮球**：
   - 检查视频光线条件
   - 调整置信度阈值
   - 确保篮球在画面中清晰可见

2. **误判进球**：
   - 调整篮筐扩展比例
   - 调整速度变化阈值
   - 确保篮筐检测准确

3. **性能问题**：
   - 降低输入分辨率
   - 使用更小的模型
   - 启用篮筐检测缓存

4. **内存错误**：
   - 减小批量大小
   - 降低输入分辨率
   - 清理临时文件

## 贡献指南

欢迎贡献代码和改进！请按照以下步骤：

1. Fork 仓库
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开 Pull Request

## 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件

## 联系方式

- 项目主页: https://github.com/Sh-iny/Basketball-detection
- 邮箱: contact@example.com

---

**© 2026 Basketball Detection System. All rights reserved.**