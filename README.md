# Basketball 目标检测与进球检测系统

## 项目概述

本项目是一个完整的篮球目标检测和进球检测系统，基于深度学习技术实现实时篮球比赛分析。系统采用单YOLO模型架构，能够同时检测篮球和篮筐，并通过多维度分析判断进球事件。

### 主要功能

- **实时篮球检测**：使用YOLO模型实时检测篮球位置
- **篮筐检测**：自动检测篮筐位置并进行位置平滑
- **进球检测**：基于位置变化、水平碰撞和速度变化的综合分析
- **目标跟踪**：跟踪篮球运动轨迹和速度
- **可视化输出**：标注视频并保存详细的进球事件记录

## 系统架构

### 单模型检测架构

系统采用**单YOLO模型**架构，使用单个模型同时检测篮球和篮筐：

```
输入视频
    │
    ▼
┌─────────────────────────────────┐
│  视频预处理 (VideoPreprocessor)  │
├─────────────────────────────────┤
│  • 亮度归一化 (LAB色彩空间)      │
│    - 目标亮度: 128              │
│    - 调整强度: 0.3              │
│  • Letterbox缩放 (保持宽高比)    │
│    - 目标尺寸: 640x640          │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│  单YOLO模型检测                 │
├─────────────────────────────────┤
│  • 模型: YOLO (BR2)            │
│  • 输入分辨率: 640              │
│  • 置信度阈值: 0.5              │
│  • 检测类别: basketball, hoop  │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│  目标跟踪与过滤                 │
├─────────────────────────────────┤
│  • 篮球跟踪器（三种可选）       │
│    - BallTracker (原始)         │
│      - 轨迹记录: 30帧           │
│      - 速度计算                 │
│    - SORT跟踪器                 │
│      - Kalman滤波预测          │
│      - 匈牙利算法数据关联       │
│      - 多目标跟踪               │
│    - 光流跟踪器 (Optical Flow)  │
│      - Lucas-Kanade算法        │
│      - 特征点检测与跟踪         │
│      - 检测间隙填补             │
│      - 光流可视化               │（未启用，仅在选择光流跟踪器时可用）
│  • 静止球过滤                   │
│    - 静止阈值: 60帧             │
│  • 跳跃检测过滤                 │
│    - 跳跃阈值: 200像素          │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│  进球检测 (GoalDetector)        │
├─────────────────────────────────┤
│  • 位置变化检测                 │
│  • 水平碰撞检测                 │
│  • 速度变化检测                 │
│  • 综合验证                     │
└─────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────┐
│  可视化输出 (VideoAnnotator)    │
├─────────────────────────────────┤
│  • 篮球边界框 (绿色)            │
│  • 篮筐边界框 (蓝色)            │
│  • 运动轨迹 (黄色, 30帧)        │
│  • 进球计数器 (右上角)          │
│  • 进球高亮 "GOAL!" (红色)      │
└─────────────────────────────────┘
    │
    ▼
输出: 标注视频 + JSON事件记录 + CSV统计
```

## 完整处理流程

### 1. 视频输入与预处理

- 读取视频帧
- 亮度归一化（LAB色彩空间）（未启用）
- Letterbox缩放（保持宽高比）（未启用）

### 2. 目标检测

- 使用单YOLO模型同时检测篮球和篮筐
- 篮筐检测缓存（每5帧更新一次）
- 篮筐位置平滑（3帧滑动平均）

### 3. 检测结果过滤

- 静止球过滤：静止超过60帧的球被认为是误检（未启用，默认值为False）
- 跳跃检测过滤：突然跳跃的检测结果被过滤（未启用，仅用于绘制轨迹时断开距离过远的点）

### 4. 目标跟踪

#### 4.1 跟踪器类型

系统支持三种篮球跟踪器，可根据不同场景选择：

##### 4.1.1 原始BallTracker
- **基本原理**：基于位置历史的简单跟踪器
- **核心功能**：
  - 轨迹记录：保存最近30帧的位置历史
  - 速度计算：基于相邻帧位置变化计算速度
  - 半径估计：基于边界框大小估计篮球半径
- **适用场景**：检测结果稳定的场景

##### 4.1.2 SORT跟踪器
- **基本原理**：结合Kalman滤波和匈牙利算法的多目标跟踪
- **核心功能**：
  - **Kalman滤波**：预测篮球位置和速度，处理检测噪声
  - **匈牙利算法**：解决检测结果与跟踪目标的关联问题
  - **多目标跟踪**：可同时跟踪多个篮球目标
- **技术参数**：
  - 目标生命周期：10帧
  - 最小命中次数：1帧
  - IoU阈值：0.2
  - 过程噪声：0.1
  - 测量噪声：5.0
- **适用场景**：篮球快速运动、频繁遮挡的场景

##### 4.1.3 光流跟踪器
- **基本原理**：基于Lucas-Kanade算法的特征点跟踪
- **核心功能**：
  - **特征点检测**：使用Shi-Tomasi角点检测算法
  - **光流计算**：跟踪特征点在连续帧中的运动
  - **检测间隙填补**：在YOLO检测丢失时保持跟踪连续性
  - **光流可视化**：显示特征点和运动轨迹（未启用）
- **技术参数**：
  - 最大丢失帧数：15帧
  - 最小特征点：3个
  - 特征点数量：100个
  - 光流计算窗口：15x15
- **适用场景**：检测结果不稳定、需要填补检测间隙的场景

#### 4.2 跟踪流程

1. **检测结果获取**：从YOLO模型获取篮球检测结果
2. **跟踪器选择**：根据配置选择使用的跟踪器
3. **跟踪更新**：
   - 有检测结果时：使用检测结果更新跟踪器
   - 无检测结果时：
     - SORT跟踪器：使用Kalman滤波预测位置
     - 光流跟踪器：使用光流算法预测位置
     - 原始BallTracker：保持最后位置
4. **轨迹管理**：
   - 记录位置历史
   - 计算运动速度和方向
   - 处理轨迹跳跃（断开距离过远的点）
5. **跟踪结果输出**：提供当前位置、速度、轨迹等信息给进球检测模块

### 5. 进球检测

#### 5.1 核心检测算法

```
输入: 篮球跟踪器, 篮筐边界框, 帧ID, 帧, FPS
输出: 是否检测到进球

处理流程:
1. 冷却期检查（进球后60帧内不重复检测）
2. 篮筐位置和半径计算（使用历史篮筐位置作为备用）
3. 球轨迹获取（从篮球跟踪器获取完整轨迹）
4. 基于轨迹的位置变化检测（从上方到下方或内部）
5. 基于轨迹的穿越检测（检查是否穿过篮筐边界）
6. 水平碰撞检测（球与篮筐边界发生碰撞）
7. 速度变化检测（球穿过篮筐时速度发生变化）
8. 综合验证（位置 + 穿越 + 碰撞 + 速度）
9. 记录进球事件（包含轨迹、速度等详细信息）
```

#### 5.2 基于轨迹的检测方法

##### 5.2.1 位置变化检测

- **核心原理**：分析球的轨迹，检查是否有从篮筐上方到下方或内部的连续变化
- **实现细节**：
  - 提取轨迹中所有在篮筐上方的点（Y坐标小于篮筐顶部）
  - 提取轨迹中所有在篮筐下方的点（Y坐标大于篮筐底部）
  - 提取轨迹中所有在篮筐内部的点（中心点在篮筐边界内）
  - 检查是否存在时间顺序正确的位置变化
  - 允许上方点和下方/内部点之间有一定间隔（最多20帧）

##### 5.2.2 穿越条件检测

- **核心原理**：检查球的轨迹是否从篮筐内部穿过篮筐的左/下/右边到外边
- **实现细节**：
  - 分析轨迹中相邻点的位置关系
  - 使用线段相交算法检测轨迹是否与篮筐边界相交
  - 检查是否有从篮筐内部到外部的穿越
  - 支持检测穿越篮筐的左边、下边或右边

#### 5.3 进球判断条件

- **位置变化**：球从篮筐上方移动到下方或内部
- **水平接近**：球在篮筐水平范围内
  - 上方点：篮筐宽度的80%范围内
  - 下方点：篮筐宽度的2倍范围内
- **时间间隔**：3-35帧内完成穿越
- **水平碰撞**：球与篮筐边界发生碰撞
  - 检测球的中心点到篮筐边界的水平距离
  - 当距离等于球半径时视为碰撞
- **速度变化**：球穿过篮筐时速度发生变化
  - 水平速度变化超过阈值（篮筐宽度的0.1倍/帧）
  - 考虑帧率影响，标准化到30fps
- **垂直速度**：球有明显的向下速度（大于1.0像素/帧）

#### 5.4 技术参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 冷却期 | 60帧 | 约2秒@30fps，避免重复检测 |
| 篮筐有效水平范围 | 80% | 篮筐宽度的百分比，用于上方点判断 |
| 下方水平范围 | 2.0x | 篮筐宽度的倍数，用于下方点判断 |
| 最大穿越帧数 | 35帧 | 球从上方到下方的最大允许帧数 |
| 最小穿越帧数 | 3帧 | 球从上方到下方的最小允许帧数 |
| 速度变化阈值 | 0.1 | 篮筐宽度/帧，水平速度变化阈值 |
| 最小水平速度 | 0.02 | 篮筐宽度/帧，启动碰撞检测的最小水平速度 |

#### 5.5 鲁棒性增强

- **篮筐位置容错**：当篮筐检测失败时，使用历史篮筐位置
- **水平范围检查增强**：当球在篮筐边界附近时，更宽松地处理水平范围检查
- **浮点数精度处理**：使用坐标比较而不是对象比较，避免浮点数精度问题
- **轨迹连续性检查**：利用轨迹的时间顺序特性，简化位置变化检测逻辑
- **多维度验证**：结合位置、穿越、碰撞和速度变化进行综合判断

#### 5.6 进球事件记录

- **详细信息**：记录球的位置、速度、轨迹、半径等信息
- **时间戳**：基于帧率计算准确的时间戳
- **篮筐信息**：记录篮筐位置和半径
- **轨迹数据**：保存进球前后的完整轨迹
- **输出格式**：JSON格式，便于后续分析和可视化

### 6. 可视化输出

- 绘制篮球和篮筐边界框
- 绘制篮球运动轨迹
- 显示进球计数
- 高亮显示进球事件
- 保存标注后的视频
- 保存进球事件JSON记录
- 保存统计信息CSV文件

## 目录结构

```
basketball/
├── goal_detection/              # 进球检测系统核心
│   ├── config/                 # 配置文件
│   │   └── goal_detection_config.yaml
│   ├── detector/               # 检测器模块
│   │   └── goal_detector.py    # 进球检测器（v1.1优化版）
│   ├── tracker/                # 跟踪器模块
│   │   ├── ball_tracker.py     # 篮球跟踪器
│   │   ├── sort_tracker.py     # SORT跟踪器
│   │   └── optical_flow_tracker.py  # 光流跟踪器
│   ├── utils/                  # 工具函数
│   │   ├── geometry.py         # 几何计算工具
│   │   └── video_preprocessor.py  # 视频预处理器（未启用）
│   ├── visualizer/             # 可视化模块
│   │   └── video_annotator.py  # 视频标注器
│   ├── goal_detection.py       # 主程序（单YOLO模型）
│   └── goal_detection_rtdetr.py  # RT-DETR版本主程序（未启用）
│
├── models/                     # 模型相关
│   ├── BR2/                    # 训练好的BR2模型（v1.1默认模型）
│   │   └── weights/
│   │       └── best.pt
│   ├── BR3/                    # 训练好的BR3模型
│   ├── attention/              # 注意力机制模块
│   ├── blocks/                 # 网络块模块
│   └── losses/                 # 损失函数模块
│
├── scripts/                    # 训练和推理脚本
│   ├── train_ball_model.py     # 篮球模型训练
│   ├── train_rim_model.py      # 篮筐模型训练
│   ├── predict_video_mp4.py    # 视频预测脚本
│   └── convert_*.py            # 数据集格式转换脚本
│
├── test/                       # 测试视频
│   ├── basketball2.mp4
│   ├── basketball3.mp4
│   └── basketball6.mp4
│
├── check_*.py                  # 数据集检查工具
├── clean_*.py                  # 数据集清理工具
├── merge_*.py                  # 数据集合并工具
├── move_*.py                   # 数据集文件移动工具
├── remove_*.py                 # 数据集清理工具
├── test_*.py                   # 测试脚本
└── README.md                   # 项目说明文件
```

## 技术参数汇总

| 模块 | 参数 | 值 | 说明 |
|------|------|-----|------|
| 模型检测 | 置信度阈值 | 0.5 | 检测置信度阈值 |
| 模型检测 | 输入分辨率 | 640 | 模型输入分辨率 |
| 篮筐检测 | 更新间隔 | 5帧 | 每5帧更新一次篮筐位置 |
| 篮筐检测 | 平滑窗口 | 3帧 | 篮筐位置平滑窗口 |
| 静止过滤 | 静止阈值 | 60帧 | 约2秒@30fps |
| 静止过滤 | 位置容差 | 30像素 | 位置网格化精度 |
| 跳跃过滤 | 跳跃阈值 | 200像素 | 单帧最大移动距离 |
| SORT跟踪 | 目标生命周期 | 10帧 | 目标最大生命周期 |
| SORT跟踪 | 最小命中次数 | 1帧 | 开始跟踪所需最小命中次数 |
| SORT跟踪 | IoU阈值 | 0.2 | 目标关联IoU阈值 |
| SORT跟踪 | 过程噪声 | 0.1 | 速度过程噪声协方差 |
| SORT跟踪 | 测量噪声 | 5.0 | 测量噪声协方差 |
| 光流跟踪 | 最大丢失帧数 | 15帧 | 目标最大丢失帧数 |
| 光流跟踪 | 最小特征点 | 3个 | 最小特征点数量 |
| 光流跟踪 | 特征点数量 | 100个 | 最大检测特征点数 |
| 光流跟踪 | 窗口大小 | 15x15 | 光流计算窗口 |
| 进球检测 | 篮筐扩展 | 1.2x | 篮筐区域扩展比例 |
| 进球检测 | 连续帧数 | 3帧 | 最小连续帧数要求 |
| 进球检测 | 冷却期 | 60帧 | 约2秒@30fps |
| 进球检测 | 速度变化阈值 | 0.3 | 水平速度变化阈值 |
| 可视化 | 轨迹长度 | 30帧 | 显示最近30帧轨迹 |
| 可视化 | 进球高亮 | 90帧 | 约3秒@30fps |

## 快速开始

### 环境要求

- Python 3.8+
- Ultralytics (YOLO)
- OpenCV
- PyTorch
- NumPy, Pandas, PyYAML
- FilterPy (SORT跟踪器所需)
- SciPy (SORT跟踪器所需)
- scikit-image (可选，用于图像处理)

### 安装依赖

```bash
pip install -r requirements.txt
```

### 测试目标检测系统

使用`test_goal_detection.py`脚本测试修改后的进球检测系统性能：

```bash
python test_goal_detection.py
```

该脚本会：
- 使用测试视频`test/basketball3.mp4`
- 默认使用`Original BallTracker`跟踪器
- 运行完整的进球检测流程
- 输出详细的检测结果和统计信息
- 生成标注视频，显示篮球轨迹和进球事件

### 运行进球检测

#### 使用SORT跟踪器（默认）

```bash
python goal_detection/goal_detection.py \
    --model models/BR2/weights/best.pt \
    --video test/basketball2.mp4 \
    --config goal_detection/config/goal_detection_config.yaml \
    --output runs/goal_detection/output.mp4 \
    --debug
```

#### 使用光流跟踪器

```bash
python goal_detection/goal_detection.py \
    --model models/BR2/weights/best.pt \
    --video test/basketball2.mp4 \
    --config goal_detection/config/goal_detection_config.yaml \
    --output runs/goal_detection/output_optical_flow.mp4 \
    --tracker optical_flow \
    --debug
```

#### 使用原始BallTracker

```bash
python goal_detection/goal_detection.py \
    --model models/BR2/weights/best.pt \
    --video test/basketball2.mp4 \
    --config goal_detection/config/goal_detection_config.yaml \
    --output runs/goal_detection/output_original.mp4 \
    --tracker original \
    --debug
```

### 命令行参数说明

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| --model | str | 是 | 检测模型路径（同时检测篮球和篮筐） |
| --video | str | 是 | 输入视频路径 |
| --config | str | 否 | 配置文件路径，默认：goal_detection/config/goal_detection_config.yaml |
| --output | str | 否 | 输出视频路径 |
| --debug | bool | 否 | 开启调试模式，输出详细检测统计 |
| --tracker | str | 否 | 跟踪器类型，可选：'sort'（默认）、'optical_flow' 或 'original' |

## 输出文件

运行后会生成以下输出文件：

- `output.mp4` - 标注后的视频（包含边界框、轨迹、进球高亮）
- `goal_events.json` - 进球事件详细记录（包含位置、速度、轨迹等）
- `goal_statistics.csv` - 进球统计信息（包含进球时间、位置等）

### JSON事件记录示例

```json
[
  {
    "frame_id": 1250,
    "timestamp": 41.67,
    "ball_position": [640, 480],
    "rim_position": [640, 320],
    "ball_velocity": [2.5, 5.8, 6.3],
    "ball_radius": 15.5,
    "rim_radius": 45.2,
    "trajectory": [[630, 450], [635, 465], [640, 480]]
  }
]
```

## 模型训练

### 训练单模型（同时检测篮球和篮筐）

```bash
python scripts/train_ball_model.py \
    --data data.yaml \
    --model yolov8n.yaml \
    --epochs 100 \
    --batch 16 \
    --name BR2
```

### 数据集准备

系统提供了多种数据集处理工具：

- `merge_datasets.py` - 合并多个数据集
- `convert_voc_to_yolo.py` - VOC格式转YOLO格式
- `convert_yolo_to_coco.py` - YOLO格式转COCO格式
- `remove_duplicates.py` - 移除重复图像
- `check_file_consistency.py` - 检查文件一致性

## 技术特点

1. **单模型设计**：使用单个YOLO模型同时检测篮球和篮筐，简化系统架构
2. **多维度进球检测**：结合位置变化、水平碰撞和速度变化进行综合判断
3. **基于轨迹的检测**：完全基于球的轨迹进行位置和穿越检测，提高检测准确性
4. **实时处理**：优化的算法设计，支持实时视频处理
5. **鲁棒性强**：考虑了球和篮筐的大小变化，适应不同场景
6. **详细的事件记录**：记录球的位置、速度、轨迹等详细信息
7. **可配置性高**：提供了详细的配置参数，可根据不同场景进行调整
8. **模块化结构**：清晰的模块划分，便于维护和扩展
9. **多种跟踪器支持**：支持原始BallTracker、SORT跟踪器和光流跟踪器
10. **检测间隙填补**：在YOLO检测丢失时使用光流预测保持跟踪连续性

## 应用场景

1. **篮球比赛分析**：自动统计进球数，分析球员表现
2. **训练辅助**：帮助教练分析球员投篮效果
3. **直播增强**：为篮球比赛直播添加实时进球检测和统计
4. **视频内容分析**：自动标记篮球视频中的关键事件
5. **体育科学研究**：分析篮球运动轨迹和投篮技术

## 测试结果

| 视频 | 进球数 | 篮球检测率 | 篮筐检测率 | 进球检测准确率 |
|------|--------|-----------|-----------|----------------|
| basketball2.mp4 | 2 | 95.2% | 99.0% | 100% |
| basketball6.mp4 | 17 | 92.8% | 99.5% | 94.1% |

## 版本历史

### v1.4（最新）
- **基于轨迹的检测**：完全基于球的轨迹进行位置和穿越检测，提高检测准确性
- **33-34秒进球检测修复**：修复了特定场景下进球未被检测的问题
- **增强水平范围检查**：当球在篮筐边界附近时，更宽松地处理水平范围检查
- **优化位置检测逻辑**：直接使用最后一个上方点和内部点进行检查，避免浮点数精度问题
- **改进时间顺序判断**：利用轨迹的时间顺序特性，简化位置变化检测逻辑
- **添加详细调试输出**：增加了针对特定帧范围的详细调试信息，便于问题排查

### v1.3
- **新增光流跟踪器**：集成Lucas-Kanade光流算法
- **检测间隙填补**：在YOLO检测丢失时使用光流预测保持跟踪连续性
- **光流可视化**：支持显示特征点和运动轨迹
- **智能跟踪切换**：有检测结果时使用检测，无检测时使用光流预测
- **优化跟踪策略**：确保只跟踪真正的篮球目标

### v1.2
- **新增SORT跟踪器**：集成Kalman滤波+匈牙利算法的多目标跟踪算法
- **增强跟踪稳定性**：提高篮球跟踪的连续性和准确性
- **优化参数配置**：针对篮球运动特点调整SORT跟踪器参数
- **添加跟踪器选择**：支持在SORT跟踪器和原始BallTracker之间切换
- **更新依赖管理**：添加FilterPy和SciPy依赖

### v1.1
- **优化进球检测逻辑**：添加水平碰撞检测和速度变化检测
- **增强事件记录**：记录球和篮筐半径信息
- **改进配置系统**：添加速度变化检测相关参数
- **优化代码结构**：提高代码可读性和可维护性

### v1.0
- **初始版本**：实现基本的篮球检测、篮筐检测和进球检测
- **单模型架构**：使用单个YOLO模型同时检测篮球和篮筐
- **实时处理**：支持实时视频处理
- **可视化输出**：标注视频并保存事件记录

## 注意事项

1. **模型选择**：推荐使用 `models/BR2/weights/best.pt` 模型
2. **配置文件**：使用 `goal_detection/config/goal_detection_config.yaml`
3. **GPU要求**：建议使用GPU加速推理
4. **视频格式**：支持常见视频格式（mp4, avi等）
5. **光线条件**：在良好的光线条件下检测效果最佳
6. **相机角度**：建议使用侧面或正面视角，避免极端俯角

## 故障排除

### 常见问题

1. **检测不到篮球**：
   - 检查视频光线条件
   - 调整置信度阈值
   - 确保篮球在画面中清晰可见

2. **误判进球**：
   - 调整篮筐扩展比例
   - 调整速度变化阈值
   - 确保篮筐检测准确

3. **性能问题**：
   - 降低输入分辨率
   - 使用更小的模型
   - 启用篮筐检测缓存

4. **内存错误**：
   - 减小批量大小
   - 降低输入分辨率
   - 清理临时文件

## 贡献指南

欢迎贡献代码和改进！请按照以下步骤：

1. Fork 仓库
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开 Pull Request

## 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件

## 联系方式

- 项目主页: https://github.com/Sh-iny/Basketball-detection
- 邮箱: contact@example.com

---

**© 2026 Basketball Detection System. All rights reserved.**